name: Setup Nightly CD

on:
  push

jobs:
  setup:
    runs-on: [ubuntu-latest]
    env:
      GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # We need to use a PAT because doing anything with the autogenerated Token does not trigger subsequent runs
    steps:
    - name: Remove old Release
      run: |
        RELEASE_ID=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | jq  '.[] | select(.tag_name == "nightly") | .id')
        curl -X DELETE -H "Authorization: token ${{ env.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID
        curl -X DELETE -H "Authorization: token ${{ env.GITHUB_TOKEN }}" https://api.github.com/git/refs/tag/repos/${{ github.repository }}/git/refs/tags/nightly
    - name: Create Release
      uses: ncipollo/release-action@v1
      with:
        body: TBD
        commit: ${{ github.sha }}
        name:  Continuous Nightly Build
        prerelease: true
        tag: nightly
        token: ${{ env.GITHUB_TOKEN }}
