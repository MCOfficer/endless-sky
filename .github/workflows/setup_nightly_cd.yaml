name: Setup Nightly CD

on:
  push

jobs:
  setup:
    runs-on: [ubuntu-latest]
    env:
      GITHUB_TOKEN: ${{ secrets.RELEASE_TOKEN }} # We need to use a PAT because doing anything with the autogenerated Token does not trigger subsequent runs
    steps:
    - name: Remove old Release
      run: |
        RELEASE_ID=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases | jq  '.[] | select(.tag_name == "nightly") | .id')
        curl -X DELETE -H "Authorization: token ${{ env.GITHUB_TOKEN }}" https://api.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID
        curl -X DELETE -H "Authorization: token ${{ env.GITHUB_TOKEN }}" https://api.github.com/git/refs/tag/repos/${{ github.repository }}/git/refs/tags/nightly
    - name: Create Release
      # https://github.com/actions/create-release/pull/32
      uses: fleskesvor/create-release@1a72e235c178bf2ae6c51a8ae36febc24568c5fe
      with:
        tag_name: nightly
        release_name: Continuous Nightly Build
        body: TBD
        prerelease: true
